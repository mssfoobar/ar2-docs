---
sidebar_position: 7
sidebar_label: Authorization
---

# Overview

With IAMS, project can choose to implement:

-   Basic Authorization
-   Fine-grained access control

IAMS provides necessary support to manage the permission and facilitate application in determining whether a user has
access to application functionality. However, the enforcing of the decision will have to be implemented by the
application.

For example, IAMS provides support to create Manager role and assign it to the user. IAMS also provide means to check
whether user has the Manager role but enforcement of whether user with Manager role can perform specific action in the
application, said approve submitted timesheet, will have to be implement by the application.

## Basic Authorization

In Basic Authorization, roles are used to grant access to the Application.

Roles are created and assigned to Users. Application permit user access to specific functionality based on the roles
that are assigned to User. For example, Timesheet Application can have 2 roles; Manager and Employee. Employee will be
able to fill and submit timesheet while the Manager will be able to approve the timesheet submitted.

The checking of role will be based on the roles listed in the `active_tenant` claim in Access Token.

Typical flow for basic authorization is as follows:

![basic authorization](/img/modules/iams/authorization/basic-authorization.png)

1. User make a request to Web App Backend.

2. Web App Backend check whether user has `Access Token` in cookies. If `Access Token` is not present, user will be
   denied access and redirect to Keycloak for authentication.

3. If `Access Token` is present, Web App Backend will then need to validate the `Access Token` to ensure it is valid.
   To check for validity of the `Access Token`, Web App Backend can use the Online or Offline Validation. See
   [Online Validation](./authentication/id-token-access-token-refresh-tokens.md#online-validation) and
   [Offline Validation](./authentication/id-token-access-token-refresh-tokens.md#offline-validation) for more
   information on `Access Token` Validation.

4. Once determine that the `access token` is valid, Web App Backend will then retrieve the roles that are assigned
   to user from the `Access Token`. Based on the roles, Web App Backend will determine whether user has the rights to
   perform the request. If user doesn’t have the required role, he will be directed to error page.

5. If has the correct role, Web App Backend can then direct the request to the Backend Services.

### Retrieve Roles from Access Token

To access the roles granted to user from the Access Token, you will need to perform the followings:

-   Split Access Token into Sections; Header, Payload, and Signature
-   Decode the payload of Access Token to JSON string
-   Retrieve the roles from the active_tenant claim in the JSON string.

Please refer to [Split Access Token into Section](./authentication/id-token-access-token-refresh-tokens.md#split-access-token-into-sections)
and [Check Issue Date and Expiry Date](./authentication/id-token-access-token-refresh-tokens.md#check-issue-date-and-expiry-date)
on how to split Access Token and decode the payload into JSON string.

After decoded the access token, you should get a JSON string with structure similar to the followings:

```json
{
  "exp" : 1721289932,
  "iat" : 1721289632,
  "auth_time" : 1721289347,
  "jti" : "a0b2a1fc-cdd8-43a4-9e95-627defac350b",
  "iss" : "http://192.168.6.44:8080/realms/AOH",
  "aud" : [ "realm-management", "account" ],
  "sub" : "b25aa224-21b2-40d7-a735-3d5f10f99146",
  "typ" : "Bearer",
  "azp" : "web-app",
  "sid" : "9774505b-835e-4729-b1d1-f11920c9284a",
  "acr" : "0",
  "allowed-origins" : [ "http://localhost:3000" ],
…
…

"preferred_username" : "tbs",
  "given_name" : "T",
  "active_tenant" : {
    "tenant_id" : "8ce3c8f2-98fa-4d06-b51c-1724c86e53aa",
    "tenant_name" : "test 2",
    "roles" : [ "tenant-admin", "Manager", "Content Creator" ]
  },
  "family_name" : "BS",
  "email" : "tbs@test.com"
}
```

To have the `active_tenant` claim available in the `Access Token`, `Select Active Tenant` required action and
`Active Tenant` Mapper need to be configured in the Realm.

Please refer to [Enable Active Tenant Required Action](../configuration/manual-keycloak-realm-setup/required-actions.md#enable-select-active-tenant-required-action)
and [Configure Active Tenant Mapper](../configuration/manual-keycloak-realm-setup/token-claims.md#configure-the-mapper)
on how to configure the `Select Active Tenant` required action and `Active Tenant` Mapper.

## Fine-grained Access Control

In fine-grained access control, resource and scope are used to grant access to the application.

Resource are created to represents protected entity or object within the Application, and scope are the action allowed
to be performed on the protected resource.

Permission to perform specific scoped action on a protected resource is then granted to user, via role assigned to
user, via group associated with user, or direct granting the permission to user.

IAMS provides the necessary APIs to evaluate whether user has been granted specified permission (specific scoped action
on specific resources) and also all the scoped actions that user is permitted on specific resource. The latter is
useful in UI rendering to determine whether certain buttons need to be show or hide based on the scoped actions
permitted to the user.

For fine-grained access control, IAMS supports:

-   **User-based Access Control (UBAC)** – user is directly granted specific permission (specific scoped action on
    specific resources).

-   **Role-based Access Control (RBAC)** – the permission is granted to the role(s) such that users assigned with those
    roles will be allowed to perform the scoped action on the resource.
    By default, roles granted with the permission are not specified as required meaning access will be granted if the
    user requesting access has been granted any of the roles.
    However, you can specify a specific role as required when granting permission to roles, such that user must have
    the required role in order to be granted access.

-   **Group-based Access Control (GBAC)** – the permission is granted to the group(s) such that users belonging to any
    of the group will be permitted to perform the scoped action on the resource.
    By default, access restriction is only applied to the groups granted with permission. However, it is possible to
    enable `Extend to Children` during the granting of the permission such that the users belonging to the subgroup of
    the granted group will also inherit the permission.

Typical flow for fine-grained authorization is as follows:

![Fine-grained Access Control](/img/modules/iams/authorization/fine-grained-access-control.png)

1. User make a request to Web App Backend.

2. Web App Backend check whether user has `Access Token` in cookies. If `Access Token` is not present, user will be
   denied access and redirect to Keycloak for authentication.

3. If `Access Token` is present, Web App Backend will then need to validate the `Access Token` to ensure it is valid.
   To check for validity of the `Access Token`, Web App Backend can use the
   [Online](./authentication/id-token-access-token-refresh-tokens.md#online-validation) or
   [Offline](./authentication/id-token-access-token-refresh-tokens.md#offline-validation) Validation.

4. Once determine that the `access token` is valid, Web App Backend will then make a request to IAMS to evaluate
   whether user is granted permission to perform specific scoped action on specific resource. If the evaluation request
   result is `Unauthorized`, application will redirect user to error page.

:::note
As part of the permission evaluation processing, IAMS will also perform Access Token validation. Hence, it is possible
to skip step 3 since it is also performed by IAMS.
:::

5. If user has the correct permission, Web App Backend can then direct the request to the Backend Services.

6. Backend Services when received the request can also invoke IAMS again to evaluate whether user has the right
   permission.
